<span class="hl com">&quot;* The Computer Language Shootout</span>
<span class="hl com">    http://shootout.alioth.debian.org/</span>
<span class="hl com">    contributed by Isaac Gouy *&quot;</span>!

<span class="hl kwc">Object</span> <span class="hl kwb">subclass:</span> <span class="hl kwd">#Body</span>   <span class="hl kwb">instanceVariableNames:</span> <span class="hl str">'x y z vx vy vz mass'</span>   <span class="hl kwb">classVariableNames:</span> <span class="hl str">''</span>   <span class="hl kwb">poolDictionaries:</span> <span class="hl str">''</span>   <span class="hl kwb">category:</span> <span class="hl str">'Shootout'</span>!

<span class="hl kwc">Object</span> <span class="hl kwb">subclass:</span> <span class="hl kwd">#NBodySystem</span>   <span class="hl kwb">instanceVariableNames:</span> <span class="hl str">'bodies'</span>   <span class="hl kwb">classVariableNames:</span> <span class="hl str">''</span>   <span class="hl kwb">poolDictionaries:</span> <span class="hl str">''</span>   <span class="hl kwb">category:</span> <span class="hl str">'Shootout'</span>!!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'accessing'</span>!mass   <span class="hl sym">^</span>mass! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'accessing'</span>!x   <span class="hl sym">^</span>x! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'accessing'</span>!<span class="hl kwb">x:</span> d1 <span class="hl kwb">y:</span> d2 <span class="hl kwb">z:</span> d3 <span class="hl kwb">vx:</span> d4 <span class="hl kwb">vy:</span> d5 <span class="hl kwb">vz:</span> d6 <span class="hl kwb">mass:</span> d7   x <span class="hl sym">:=</span> d1<span class="hl sym">.</span>   y <span class="hl sym">:=</span> d2<span class="hl sym">.</span>    z <span class="hl sym">:=</span> d3<span class="hl sym">.</span>    vx <span class="hl sym">:=</span> d4<span class="hl sym">.</span>   vy <span class="hl sym">:=</span> d5<span class="hl sym">.</span>   vz <span class="hl sym">:=</span> d6<span class="hl sym">.</span>   mass <span class="hl sym">:=</span> d7! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'accessing'</span>!y   <span class="hl sym">^</span>y! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'accessing'</span>!z   <span class="hl sym">^</span>z! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">addMomentumTo:</span> anArray   anArray <span class="hl kwb">at:</span> <span class="hl num">1</span> <span class="hl kwb">put:</span> <span class="hl sym">(</span>anArray <span class="hl kwb">at:</span> <span class="hl num">1</span><span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>vx <span class="hl kwb">*</span> mass<span class="hl sym">).</span>   anArray <span class="hl kwb">at:</span> <span class="hl num">2</span> <span class="hl kwb">put:</span> <span class="hl sym">(</span>anArray <span class="hl kwb">at:</span> <span class="hl num">2</span><span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>vy <span class="hl kwb">*</span> mass<span class="hl sym">).</span>   anArray <span class="hl kwb">at:</span> <span class="hl num">3</span> <span class="hl kwb">put:</span> <span class="hl sym">(</span>anArray <span class="hl kwb">at:</span> <span class="hl num">3</span><span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>vz <span class="hl kwb">*</span> mass<span class="hl sym">).   ^</span>anArray! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">and:</span> aBody <span class="hl kwb">velocityAfter:</span> dt           <span class="hl kwd">| dx dy dz distance mag |</span>   dx <span class="hl sym">:=</span> x <span class="hl kwb">-</span> aBody <span class="hl kwb">x</span><span class="hl sym">.</span>   dy <span class="hl sym">:=</span> y <span class="hl kwb">-</span> aBody <span class="hl kwb">y</span><span class="hl sym">.</span>   dz <span class="hl sym">:=</span> z <span class="hl kwb">-</span> aBody <span class="hl kwb">z</span><span class="hl sym">.</span>      distance <span class="hl sym">:= ((</span>dx<span class="hl kwb">*</span>dx<span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>dy<span class="hl kwb">*</span>dy<span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>dz<span class="hl kwb">*</span>dz<span class="hl sym">))</span> <span class="hl kwb">sqrt</span><span class="hl sym">.</span>   mag <span class="hl sym">:=</span> dt <span class="hl kwb">/</span> <span class="hl sym">(</span>distance <span class="hl kwb">*</span> distance <span class="hl kwb">*</span> distance<span class="hl sym">).</span>   <span class="hl kwa">self</span> <span class="hl kwb">decreaseVelocity:</span> dx <span class="hl kwb">y:</span> dy <span class="hl kwb">z:</span> dz <span class="hl kwb">m:</span> aBody <span class="hl kwb">mass *</span> mag<span class="hl sym">.</span>      aBody <span class="hl kwb">increaseVelocity:</span> dx <span class="hl kwb">y:</span> dy <span class="hl kwb">z:</span> dz <span class="hl kwb">m:</span> mass <span class="hl kwb">*</span> mag! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">decreaseVelocity:</span> dx <span class="hl kwb">y:</span> dy <span class="hl kwb">z:</span> dz <span class="hl kwb">m:</span> m   vx <span class="hl sym">:=</span> vx <span class="hl kwb">-</span> <span class="hl sym">(</span>dx <span class="hl kwb">*</span> m<span class="hl sym">).</span>   vy <span class="hl sym">:=</span> vy <span class="hl kwb">-</span> <span class="hl sym">(</span>dy <span class="hl kwb">*</span> m<span class="hl sym">).</span>   vz <span class="hl sym">:=</span> vz <span class="hl kwb">-</span> <span class="hl sym">(</span>dz <span class="hl kwb">*</span> m<span class="hl sym">)</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">increaseVelocity:</span> dx <span class="hl kwb">y:</span> dy <span class="hl kwb">z:</span> dz <span class="hl kwb">m:</span> m   vx <span class="hl sym">:=</span> vx <span class="hl kwb">+</span> <span class="hl sym">(</span>dx <span class="hl kwb">*</span> m<span class="hl sym">).</span>   vy <span class="hl sym">:=</span> vy <span class="hl kwb">+</span> <span class="hl sym">(</span>dy <span class="hl kwb">*</span> m<span class="hl sym">).</span>   vz <span class="hl sym">:=</span> vz <span class="hl kwb">+</span> <span class="hl sym">(</span>dz <span class="hl kwb">*</span> m<span class="hl sym">)</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!kineticEnergy   <span class="hl sym">^</span><span class="hl num">0.5</span>d0 <span class="hl kwb">*</span> mass <span class="hl kwb">*</span> <span class="hl sym">((</span>vx <span class="hl kwb">*</span> vx<span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>vy <span class="hl kwb">*</span> vy<span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>vz <span class="hl kwb">*</span> vz<span class="hl sym">))</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">offsetMomentum:</span> anArray    <span class="hl kwd">| m |</span>   m <span class="hl sym">:=</span> <span class="hl kwa">self</span> <span class="hl kwb">class solarMass</span><span class="hl sym">.</span>   vx <span class="hl sym">:= (</span>anArray <span class="hl kwb">at:</span> <span class="hl num">1</span><span class="hl sym">)</span> <span class="hl kwb">negated /</span> m<span class="hl sym">.</span>   vy <span class="hl sym">:= (</span>anArray <span class="hl kwb">at:</span> <span class="hl num">2</span><span class="hl sym">)</span> <span class="hl kwb">negated /</span> m<span class="hl sym">.</span>   vz <span class="hl sym">:= (</span>anArray <span class="hl kwb">at:</span> <span class="hl num">3</span><span class="hl sym">)</span> <span class="hl kwb">negated /</span> m! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">positionAfter:</span> dt   x <span class="hl sym">:=</span> x <span class="hl kwb">+</span> <span class="hl sym">(</span>dt <span class="hl kwb">*</span> vx<span class="hl sym">).</span>   y <span class="hl sym">:=</span> y <span class="hl kwb">+</span> <span class="hl sym">(</span>dt <span class="hl kwb">*</span> vy<span class="hl sym">).</span>   z <span class="hl sym">:=</span> z <span class="hl kwb">+</span> <span class="hl sym">(</span>dt <span class="hl kwb">*</span> vz<span class="hl sym">)</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">potentialEnergy:</span> aBody   <span class="hl kwd">| dx dy dz distance |</span>   dx <span class="hl sym">:=</span> x <span class="hl kwb">-</span> aBody <span class="hl kwb">x</span><span class="hl sym">.</span>   dy <span class="hl sym">:=</span> y <span class="hl kwb">-</span> aBody <span class="hl kwb">y</span><span class="hl sym">.</span>   dz <span class="hl sym">:=</span> z <span class="hl kwb">-</span> aBody <span class="hl kwb">z</span><span class="hl sym">.</span>   distance <span class="hl sym">:= ((</span>dx<span class="hl kwb">*</span>dx<span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>dy<span class="hl kwb">*</span>dy<span class="hl sym">)</span> <span class="hl kwb">+</span> <span class="hl sym">(</span>dz<span class="hl kwb">*</span>dz<span class="hl sym">))</span> <span class="hl kwb">sqrt</span><span class="hl sym">.   ^</span>mass <span class="hl kwb">*</span> aBody <span class="hl kwb">mass /</span> distance! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!daysPerYear   <span class="hl sym">^</span><span class="hl num">365.24</span>d0! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!jupiter   <span class="hl sym">^</span><span class="hl kwa">self</span> <span class="hl kwb">new      x:</span> <span class="hl num">4.84143144246472090</span>d0      <span class="hl kwb">y: -</span><span class="hl num">1.16032004402742839</span>d0      <span class="hl kwb">z: -</span><span class="hl num">1.03622044471123109</span>d<span class="hl kwb">-</span><span class="hl num">1</span>      <span class="hl kwb">vx:</span> <span class="hl num">1.66007664274403694</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vy:</span> <span class="hl num">7.69901118419740425</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vz: -</span><span class="hl num">6.90460016972063023</span>d<span class="hl kwb">-</span><span class="hl num">5</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      mass:</span> <span class="hl num">9.54791938424326609</span>d<span class="hl kwb">-</span><span class="hl num">4</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">solarMass</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!neptune   <span class="hl sym">^</span><span class="hl kwa">self</span> <span class="hl kwb">new      x:</span> <span class="hl num">1.53796971148509165</span>d1      <span class="hl kwb">y: -</span><span class="hl num">2.59193146099879641</span>d1      <span class="hl kwb">z:</span> <span class="hl num">1.79258772950371181</span>d<span class="hl kwb">-</span><span class="hl num">1</span>      <span class="hl kwb">vx:</span> <span class="hl num">2.68067772490389322</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vy:</span> <span class="hl num">1.62824170038242295</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vz: -</span><span class="hl num">9.51592254519715870</span>d<span class="hl kwb">-</span><span class="hl num">5</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      mass:</span> <span class="hl num">5.15138902046611451</span>d<span class="hl kwb">-</span><span class="hl num">5</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">solarMass</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!pi   <span class="hl sym">^</span><span class="hl num">3.141592653589793</span>d0! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!saturn   <span class="hl sym">^</span><span class="hl kwa">self</span> <span class="hl kwb">new      x:</span> <span class="hl num">8.34336671824457987</span>d0      <span class="hl kwb">y:</span> <span class="hl num">4.12479856412430479</span>d0      <span class="hl kwb">z: -</span><span class="hl num">4.03523417114321381</span>d<span class="hl kwb">-</span><span class="hl num">1</span>      <span class="hl kwb">vx: -</span><span class="hl num">2.76742510726862411</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vy:</span> <span class="hl num">4.99852801234917238</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vz:</span> <span class="hl num">2.30417297573763929</span>d<span class="hl kwb">-</span><span class="hl num">5</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      mass:</span> <span class="hl num">2.85885980666130812</span>d<span class="hl kwb">-</span><span class="hl num">4</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">solarMass</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!solarMass   <span class="hl sym">^</span><span class="hl num">4.0</span>d0 <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">pi *</span> <span class="hl kwa">self</span> <span class="hl kwb">pi</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!sun   <span class="hl sym">^</span><span class="hl kwa">self</span> <span class="hl kwb">new      x:</span> <span class="hl num">0.0</span>d0      <span class="hl kwb">y:</span> <span class="hl num">0.0</span>d0      <span class="hl kwb">z:</span> <span class="hl num">0.0</span>d0      <span class="hl kwb">vx:</span> <span class="hl num">0.0</span>d0      <span class="hl kwb">vy:</span> <span class="hl num">0.0</span>d0      <span class="hl kwb">vz:</span> <span class="hl num">0.0</span>d0      <span class="hl kwb">mass:</span> <span class="hl kwa">self</span> <span class="hl kwb">solarMass</span>! !!<span class="hl kwc">Body</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'constants'</span>!uranus   <span class="hl sym">^</span><span class="hl kwa">self</span> <span class="hl kwb">new      x:</span> <span class="hl num">1.28943695621391310</span>d1      <span class="hl kwb">y: -</span><span class="hl num">1.51111514016986312</span>d1      <span class="hl kwb">z: -</span><span class="hl num">2.23307578892655734</span>d<span class="hl kwb">-</span><span class="hl num">1</span>      <span class="hl kwb">vx:</span> <span class="hl num">2.96460137564761618</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vy:</span> <span class="hl num">2.37847173959480950</span>d<span class="hl kwb">-</span><span class="hl num">3</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      vz: -</span><span class="hl num">2.96589568540237556</span>d<span class="hl kwb">-</span><span class="hl num">5</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">daysPerYear      mass:</span> <span class="hl num">4.36624404335156298</span>d<span class="hl kwb">-</span><span class="hl num">5</span> <span class="hl kwb">*</span> <span class="hl kwa">self</span> <span class="hl kwb">solarMass</span>! !!<span class="hl kwc">NBodySystem</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!<span class="hl kwb">after:</span> dt   <span class="hl num">1</span> <span class="hl kwb">to:</span> bodies <span class="hl kwb">size do:</span> <span class="hl sym">[</span><span class="hl kwd">:i</span><span class="hl sym">|</span>      i<span class="hl kwb">+</span><span class="hl num">1</span> <span class="hl kwb">to:</span> bodies <span class="hl kwb">size do:</span> <span class="hl sym">[</span><span class="hl kwd">:j</span><span class="hl sym">|                                     (</span>bodies <span class="hl kwb">at:</span> i<span class="hl sym">)</span> <span class="hl kwb">and:</span> <span class="hl sym">(</span>bodies <span class="hl kwb">at:</span> j<span class="hl sym">)</span> <span class="hl kwb">velocityAfter:</span> dt<span class="hl sym">].   ].</span>      bodies <span class="hl kwb">do:</span> <span class="hl sym">[</span><span class="hl kwd">:each</span><span class="hl sym">|</span> each <span class="hl kwb">positionAfter:</span> dt<span class="hl sym">]</span>! !!<span class="hl kwc">NBodySystem</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'nbody'</span>!energy   <span class="hl kwd">| e |</span>   e <span class="hl sym">:=</span> <span class="hl num">0.0</span>d0<span class="hl sym">.</span>   <span class="hl num">1</span> <span class="hl kwb">to:</span> bodies <span class="hl kwb">size do:</span> <span class="hl sym">[</span><span class="hl kwd">:i</span><span class="hl sym">|</span>             e <span class="hl sym">:=</span> e <span class="hl kwb">+</span> <span class="hl sym">(</span>bodies <span class="hl kwb">at:</span> i<span class="hl sym">)</span> <span class="hl kwb">kineticEnergy</span><span class="hl sym">.</span>      i<span class="hl kwb">+</span><span class="hl num">1</span> <span class="hl kwb">to:</span> bodies <span class="hl kwb">size do:</span> <span class="hl sym">[</span><span class="hl kwd">:j</span><span class="hl sym">|</span>          e <span class="hl sym">:=</span> e <span class="hl kwb">-</span> <span class="hl sym">((</span>bodies <span class="hl kwb">at:</span> i<span class="hl sym">)</span> <span class="hl kwb">potentialEnergy:</span> <span class="hl sym">(</span>bodies <span class="hl kwb">at:</span> j<span class="hl sym">))].   ].   ^</span>e! !!<span class="hl kwc">NBodySystem</span> <span class="hl kwb">methodsFor:</span> <span class="hl str">'initialize-release'</span>!initialize   bodies <span class="hl sym">:=</span> <span class="hl kwc">OrderedCollection</span> <span class="hl kwb">new      add:</span> <span class="hl kwc">Body</span> <span class="hl kwb">sun</span><span class="hl sym">;</span> <span class="hl kwb">add:</span> <span class="hl kwc">Body</span> <span class="hl kwb">jupiter</span><span class="hl sym">;</span> <span class="hl kwb">add:</span> <span class="hl kwc">Body</span> <span class="hl kwb">saturn</span><span class="hl sym">;</span>      <span class="hl kwb">add:</span> <span class="hl kwc">Body</span> <span class="hl kwb">uranus</span><span class="hl sym">;</span> <span class="hl kwb">add:</span> <span class="hl kwc">Body</span> <span class="hl kwb">neptune</span><span class="hl sym">;</span> <span class="hl kwb">yourself</span><span class="hl sym">.</span>   bodies <span class="hl kwb">first offsetMomentum:</span>      <span class="hl sym">(</span>bodies <span class="hl kwb">inject:</span> <span class="hl sym">(</span><span class="hl kwc">Array</span> <span class="hl kwb">with:</span> <span class="hl num">0.0</span>d0 <span class="hl kwb">with:</span> <span class="hl num">0.0</span>d0 <span class="hl kwb">with:</span> <span class="hl num">0.0</span>d0<span class="hl sym">)</span>         <span class="hl kwb">into:</span> <span class="hl sym">[</span><span class="hl kwd">:m :each</span> <span class="hl sym">|</span> each <span class="hl kwb">addMomentumTo:</span> m<span class="hl sym">])</span>! !!<span class="hl kwc">Tests</span> <span class="hl kwb">class methodsFor:</span> <span class="hl str">'benchmark scripts'</span>!nbody   <span class="hl kwd">| bodies |</span>   bodies <span class="hl sym">:=</span> <span class="hl kwc">NBodySystem</span> <span class="hl kwb">new initialize</span><span class="hl sym">.</span>   <span class="hl kwa">self</span> <span class="hl kwb">stdout print:</span> bodies <span class="hl kwb">energy digits:</span> <span class="hl num">9</span><span class="hl sym">;</span> <span class="hl kwb">nl</span><span class="hl sym">.</span>   <span class="hl kwa">self</span> <span class="hl kwb">arg timesRepeat:</span> <span class="hl sym">[</span>bodies <span class="hl kwb">after:</span> <span class="hl num">0.01</span>d0<span class="hl sym">].</span>   <span class="hl kwa">self</span> <span class="hl kwb">stdout print:</span> bodies <span class="hl kwb">energy digits:</span> <span class="hl num">9</span><span class="hl sym">;</span> <span class="hl kwb">nl</span><span class="hl sym">.   ^</span><span class="hl str">''</span>! !

<span class="hl kwc">Tests</span> <span class="hl kwb">nbody</span>!
