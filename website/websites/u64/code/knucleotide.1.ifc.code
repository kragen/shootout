<span class="hl slc">! -*- mode: f90 -*-</span>
<span class="hl slc">!</span>
<span class="hl slc">! The Computer Language Shootout Benchmarks</span>
<span class="hl slc">! http://shootout.alioth.debian.org/</span>
<span class="hl slc">!</span>
<span class="hl slc">! contributed by Steve Decker</span>
<span class="hl slc">! using the hash function posted by Rich Townsend to comp.lang.fortran</span>
<span class="hl slc">! on 5 October 2005.</span>
<span class="hl slc">! compilation:</span>
<span class="hl slc">!    g95 -O1 knucleotide.f90</span>
<span class="hl slc">!    ifort -O3 -ip knucleotide.f90</span>
<span class="hl slc">!</span>
<span class="hl slc">! This implementation requires TR15581</span>

<span class="hl kwa">module</span> knuc_mod
  <span class="hl kwa">implicit none</span>
  private
  public <span class="hl sym">::</span> init_table<span class="hl sym">,</span> read_frame<span class="hl sym">,</span> keys_of_given_len<span class="hl sym">,</span> cnt

  <span class="hl kwb">integer</span><span class="hl sym">,</span> <span class="hl kwa">parameter</span> <span class="hl sym">::</span> MaxWordLen <span class="hl sym">=</span> <span class="hl num">18</span>

  <span class="hl kwa">type</span><span class="hl sym">,</span> public <span class="hl sym">::</span> <span class="hl kwa">key</span>
     <span class="hl kwb">integer</span>                   <span class="hl sym">::</span> count <span class="hl sym">=</span> <span class="hl num">0</span>
     <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=</span>MaxWordLen<span class="hl sym">) ::</span> word <span class="hl sym">=</span> <span class="hl str">&quot;&quot;</span>
  <span class="hl kwa">end type key</span>

  <span class="hl kwa">type</span><span class="hl sym">,</span> public <span class="hl sym">::</span> table
     private
     <span class="hl kwb">integer</span> <span class="hl sym">::</span> hashBits<span class="hl sym">,</span> maxWords<span class="hl sym">,</span> nWords
     <span class="hl kwa">type</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">),</span> allocatable<span class="hl sym">,</span> <span class="hl kwa">dimension</span><span class="hl sym">(:) ::</span> words
  <span class="hl kwa">end type</span> table

<span class="hl kwa">contains</span>

  pure <span class="hl kwa">subroutine</span> <span class="hl kwd">init_table</span><span class="hl sym">(</span>kNuc<span class="hl sym">,</span> nBits<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>out<span class="hl sym">) ::</span> kNuc
    <span class="hl kwb">integer</span><span class="hl sym">,</span>     <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">)  ::</span> nBits

    kNuc <span class="hl sym">=</span> <span class="hl kwd">table</span><span class="hl sym">(</span>nBits<span class="hl sym">,</span> <span class="hl num">2</span><span class="hl sym">**</span>nBits<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> <span class="hl kwd">null</span><span class="hl sym">())</span>
    <span class="hl kwd">allocate</span><span class="hl sym">(</span>kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>kNuc<span class="hl sym">%</span>maxWords<span class="hl sym">))</span>
  <span class="hl kwa">end subroutine</span> init_table

  <span class="hl kwa">subroutine</span> <span class="hl kwd">read_frame</span><span class="hl sym">(</span>buf<span class="hl sym">,</span> n<span class="hl sym">,</span> length<span class="hl sym">,</span> kNuc<span class="hl sym">)</span>
    <span class="hl kwb">character</span><span class="hl sym">,</span> <span class="hl kwa">dimension</span><span class="hl sym">(:),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">)    ::</span> buf
    <span class="hl kwb">integer</span><span class="hl sym">,</span>                 <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">)    ::</span> n<span class="hl sym">,</span> length
    <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">),</span>             <span class="hl kwd">intent</span><span class="hl sym">(</span>inout<span class="hl sym">) ::</span> kNuc

    <span class="hl kwb">integer</span>               <span class="hl sym">::</span> i<span class="hl sym">,</span> j
    <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=</span>length<span class="hl sym">) ::</span> word

    <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> n
       <span class="hl kwa">do</span> j <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> length
          <span class="hl kwd">word</span><span class="hl sym">(</span>j<span class="hl sym">:</span>j<span class="hl sym">) =</span> <span class="hl kwd">buf</span><span class="hl sym">(</span>i<span class="hl sym">+</span>j<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">)</span>
       <span class="hl kwa">end do</span>
       <span class="hl kwa">call</span> <span class="hl kwd">add</span><span class="hl sym">(</span>kNuc<span class="hl sym">,</span> word<span class="hl sym">)</span>
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end subroutine</span> read_frame

  <span class="hl kwa">subroutine</span> <span class="hl kwd">add</span><span class="hl sym">(</span>kNuc<span class="hl sym">,</span> word<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">),</span>      <span class="hl kwd">intent</span><span class="hl sym">(</span>inout<span class="hl sym">) ::</span> kNuc
    <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=*),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">)    ::</span> word

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> m

    m <span class="hl sym">=</span> <span class="hl kwd">hash_value</span><span class="hl sym">(</span>word<span class="hl sym">,</span> kNuc<span class="hl sym">%</span>maxWords<span class="hl sym">)</span>
    <span class="hl kwa">do</span>
       <span class="hl kwa">if</span> <span class="hl sym">(</span>kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>count <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">then</span>
          kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">) =</span> <span class="hl kwa">key</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span> word<span class="hl sym">)</span>
          kNuc<span class="hl sym">%</span>nWords <span class="hl sym">=</span> kNuc<span class="hl sym">%</span>nWords <span class="hl sym">+</span> <span class="hl num">1</span>
          <span class="hl kwa">if</span> <span class="hl sym">(</span>kNuc<span class="hl sym">%</span>nWords <span class="hl sym">&gt;</span> kNuc<span class="hl sym">%</span>maxWords<span class="hl sym">/</span><span class="hl num">2</span><span class="hl sym">)</span> <span class="hl kwa">call</span> <span class="hl kwd">resize_table</span><span class="hl sym">(</span>kNuc<span class="hl sym">)</span>
          exit
       <span class="hl kwa">else if</span> <span class="hl sym">(</span>kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>word <span class="hl sym">==</span> word<span class="hl sym">)</span> <span class="hl kwa">then</span>
          kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>count <span class="hl sym">=</span> kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>count <span class="hl sym">+</span> <span class="hl num">1</span>
          exit
       <span class="hl kwa">end if</span>
       m <span class="hl sym">=</span> <span class="hl kwd">merge</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span> m<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">,</span> m <span class="hl sym">==</span> kNuc<span class="hl sym">%</span>maxWords<span class="hl sym">)</span>
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end subroutine</span> add

  <span class="hl kwa">subroutine</span> <span class="hl kwd">resize_table</span><span class="hl sym">(</span>kNuc<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>inout<span class="hl sym">) ::</span> kNuc

    <span class="hl kwb">integer</span>     <span class="hl sym">::</span> i<span class="hl sym">,</span> m
    <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">) ::</span> temp

    temp <span class="hl sym">=</span> <span class="hl kwd">table</span><span class="hl sym">(</span>kNuc<span class="hl sym">%</span>hashBits <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">,</span> <span class="hl num">2</span> <span class="hl sym">*</span> kNuc<span class="hl sym">%</span>maxWords<span class="hl sym">,</span> kNuc<span class="hl sym">%</span>nWords<span class="hl sym">,</span> <span class="hl kwd">null</span><span class="hl sym">())</span>
    <span class="hl kwd">allocate</span><span class="hl sym">(</span>temp<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>temp<span class="hl sym">%</span>maxWords<span class="hl sym">))</span>

    <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> kNuc<span class="hl sym">%</span>maxWords
       <span class="hl kwa">if</span> <span class="hl sym">(</span>kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>i<span class="hl sym">)%</span>count <span class="hl sym">&gt;</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">then</span>
          m <span class="hl sym">=</span> <span class="hl kwd">hash_value</span><span class="hl sym">(</span><span class="hl kwd">trim</span><span class="hl sym">(</span>kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>i<span class="hl sym">)%</span>word<span class="hl sym">),</span> temp<span class="hl sym">%</span>maxWords<span class="hl sym">)</span>
          <span class="hl kwa">do</span>
             <span class="hl kwa">if</span> <span class="hl sym">(</span>temp<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>count <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">then</span>
                temp<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">) =</span> kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>i<span class="hl sym">)</span>
                exit
             <span class="hl kwa">end if</span>
             m <span class="hl sym">=</span> <span class="hl kwd">merge</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span> m<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">,</span> m <span class="hl sym">==</span> temp<span class="hl sym">%</span>maxWords<span class="hl sym">)</span>
          <span class="hl kwa">end do</span>
       <span class="hl kwa">end if</span>
    <span class="hl kwa">end do</span>

    kNuc <span class="hl sym">=</span> temp
  <span class="hl kwa">end subroutine</span> resize_table

  pure <span class="hl kwa">function</span> <span class="hl kwd">keys_of_given_len</span><span class="hl sym">(</span>kNuc<span class="hl sym">,</span> length<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> kNuc
    <span class="hl kwb">integer</span><span class="hl sym">,</span>     <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> length
    <span class="hl kwa">type</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">4</span><span class="hl sym">**</span>length<span class="hl sym">) ::</span> keys_of_given_len

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> i<span class="hl sym">,</span> n

    n <span class="hl sym">=</span> <span class="hl num">1</span>
    <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> kNuc<span class="hl sym">%</span>maxWords
       <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">len_trim</span><span class="hl sym">(</span>kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>i<span class="hl sym">)%</span>word<span class="hl sym">) ==</span> length<span class="hl sym">)</span> <span class="hl kwa">then</span>
          <span class="hl kwd">keys_of_given_len</span><span class="hl sym">(</span>n<span class="hl sym">) =</span> kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>i<span class="hl sym">)</span>
          n <span class="hl sym">=</span> n <span class="hl sym">+</span> <span class="hl num">1</span>
          <span class="hl kwa">if</span> <span class="hl sym">(</span>n <span class="hl sym">&gt;</span> <span class="hl kwd">size</span><span class="hl sym">(</span>keys_of_given_len<span class="hl sym">))</span> exit
       <span class="hl kwa">end if</span>
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end function</span> keys_of_given_len

  <span class="hl kwb">integer</span> <span class="hl kwa">function</span> <span class="hl kwd">cnt</span><span class="hl sym">(</span>kNuc<span class="hl sym">,</span> string<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">)      ::</span> kNuc
    <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=*),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> string

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> m

    m <span class="hl sym">=</span> <span class="hl kwd">hash_value</span><span class="hl sym">(</span>string<span class="hl sym">,</span> kNuc<span class="hl sym">%</span>maxWords<span class="hl sym">)</span>
    <span class="hl kwa">do</span>
       <span class="hl kwa">if</span> <span class="hl sym">(</span>kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>word <span class="hl sym">==</span> string <span class="hl sym">.</span>or<span class="hl sym">.</span> kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>count <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">then</span>
          cnt <span class="hl sym">=</span> kNuc<span class="hl sym">%</span><span class="hl kwd">words</span><span class="hl sym">(</span>m<span class="hl sym">)%</span>count
          exit
       <span class="hl kwa">end if</span>
       m <span class="hl sym">=</span> <span class="hl kwd">merge</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span> m<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">,</span> m <span class="hl sym">==</span> kNuc<span class="hl sym">%</span>maxWords<span class="hl sym">)</span>
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end function</span> cnt

  <span class="hl kwb">integer</span> <span class="hl kwa">function</span> <span class="hl kwd">hash_value</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">,</span> range<span class="hl sym">)</span>
    <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=*),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> <span class="hl kwa">key</span>
    <span class="hl kwb">integer</span><span class="hl sym">,</span>          <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> range

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> len_key<span class="hl sym">,</span> a<span class="hl sym">,</span> b<span class="hl sym">,</span> c<span class="hl sym">,</span> k

    <span class="hl slc">! Hash the key into a code, using the algorithm</span>
    <span class="hl slc">! described by Bob Jenkins at:</span>
    <span class="hl slc">!  http://burtleburtle.net/bob/hash/doobs.html</span>
    <span class="hl slc">!</span>
    <span class="hl slc">! Note that range should be a power of 2, and</span>
    <span class="hl slc">! that the 32-bit algorithm is used</span>

    len_key <span class="hl sym">=</span> <span class="hl kwd">len</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">)</span>

    a <span class="hl sym">= -</span><span class="hl num">1640531527</span> <span class="hl slc">! 0x9E3779B9</span>
    b <span class="hl sym">=</span> a
    c <span class="hl sym">=</span> <span class="hl num">305419896</span>   <span class="hl slc">! 0x12345678</span>

    k <span class="hl sym">=</span> <span class="hl num">1</span>

    <span class="hl kwa">do</span>
       <span class="hl kwa">if</span> <span class="hl sym">(</span>len_key <span class="hl sym">&lt;</span> <span class="hl num">12</span><span class="hl sym">)</span> exit

       <span class="hl slc">! Pack the key into 32 bits</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">)) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span> <span class="hl num">8</span><span class="hl sym">) +  &amp;</span>
            <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span> <span class="hl num">16</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span> <span class="hl num">24</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">)) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">)),</span> <span class="hl num">8</span><span class="hl sym">) +  &amp;</span>
            <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">)),</span> <span class="hl num">16</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">)),</span> <span class="hl num">24</span><span class="hl sym">)</span>
       c <span class="hl sym">=</span> c <span class="hl sym">+</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">)) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">9</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">9</span><span class="hl sym">)),</span> <span class="hl num">8</span><span class="hl sym">) +  &amp;</span>
            <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">10</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">10</span><span class="hl sym">)),</span> <span class="hl num">16</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">11</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">11</span><span class="hl sym">)),</span> <span class="hl num">24</span><span class="hl sym">)</span>

       <span class="hl slc">! Mix it up</span>
       <span class="hl kwa">call</span> <span class="hl kwd">hash_mix</span><span class="hl sym">()</span>
       k <span class="hl sym">=</span> k <span class="hl sym">+</span> <span class="hl num">12</span>
       len_key <span class="hl sym">=</span> len_key <span class="hl sym">-</span> <span class="hl num">12</span>
    <span class="hl kwa">end do</span>

    c <span class="hl sym">=</span> c <span class="hl sym">+</span> len_key

    <span class="hl slc">! Process remaining bits</span>
    select <span class="hl kwd">case</span><span class="hl sym">(</span>len_key<span class="hl sym">)</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">11</span><span class="hl sym">)</span>
       c <span class="hl sym">=</span> c <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">10</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">10</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">9</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">9</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">))</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">10</span><span class="hl sym">)</span>
       c <span class="hl sym">=</span> c <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">9</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">9</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">))</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">9</span><span class="hl sym">)</span>
       c <span class="hl sym">=</span> c <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">8</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">))</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">8</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">7</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">))</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">7</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">6</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">))</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">6</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">5</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">))</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">5</span><span class="hl sym">)</span>
       b <span class="hl sym">=</span> b <span class="hl sym">+</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">4</span><span class="hl sym">))</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">4</span><span class="hl sym">)</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">3</span><span class="hl sym">)),</span><span class="hl num">24</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">3</span><span class="hl sym">)</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">2</span><span class="hl sym">)),</span><span class="hl num">16</span><span class="hl sym">) +</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">)  &amp;</span>
            <span class="hl sym">+</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">)</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span><span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span>k<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)),</span><span class="hl num">8</span><span class="hl sym">) +</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwd">case</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">)</span>
       a <span class="hl sym">=</span> a <span class="hl sym">+</span> <span class="hl kwd">ichar</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">))</span>
    <span class="hl kwa">end</span> select

    <span class="hl kwa">call</span> <span class="hl kwd">hash_mix</span><span class="hl sym">()</span>

    hash_value <span class="hl sym">=</span> <span class="hl kwd">iand</span><span class="hl sym">(</span>c<span class="hl sym">,</span> range <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">) +</span> <span class="hl num">1</span>

  <span class="hl kwa">contains</span>

    <span class="hl kwa">subroutine</span> hash_mix
      <span class="hl slc">! Mix a, b and c</span>
      a <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>a <span class="hl sym">-</span> b <span class="hl sym">-</span> c<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>c<span class="hl sym">, -</span><span class="hl num">13</span><span class="hl sym">))</span>
      b <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>b <span class="hl sym">-</span> c <span class="hl sym">-</span> a<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>a<span class="hl sym">,</span> <span class="hl num">8</span><span class="hl sym">))</span>
      c <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>c <span class="hl sym">-</span> a <span class="hl sym">-</span> b<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>b<span class="hl sym">, -</span><span class="hl num">13</span><span class="hl sym">))</span>

      a <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>a <span class="hl sym">-</span> b <span class="hl sym">-</span> c<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>c<span class="hl sym">, -</span><span class="hl num">12</span><span class="hl sym">))</span>
      b <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>b <span class="hl sym">-</span> c <span class="hl sym">-</span> a<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>a<span class="hl sym">,</span> <span class="hl num">16</span><span class="hl sym">))</span>
      c <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>c <span class="hl sym">-</span> a <span class="hl sym">-</span> b<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>b<span class="hl sym">, -</span><span class="hl num">5</span><span class="hl sym">))</span>

      a <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>a <span class="hl sym">-</span> b <span class="hl sym">-</span> c<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>c<span class="hl sym">, -</span><span class="hl num">3</span><span class="hl sym">))</span>
      b <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>b <span class="hl sym">-</span> c <span class="hl sym">-</span> a<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>a<span class="hl sym">,</span> <span class="hl num">10</span><span class="hl sym">))</span>
      c <span class="hl sym">=</span> <span class="hl kwd">ieor</span><span class="hl sym">(</span>c <span class="hl sym">-</span> a <span class="hl sym">-</span> b<span class="hl sym">,</span> <span class="hl kwd">ishft</span><span class="hl sym">(</span>b<span class="hl sym">, -</span><span class="hl num">15</span><span class="hl sym">))</span>
    <span class="hl kwa">end subroutine</span> hash_mix
  <span class="hl kwa">end function</span> hash_value
<span class="hl kwa">end module</span> knuc_mod

<span class="hl kwa">program</span> knucleotide
  <span class="hl kwa">use</span> knuc_mod
  <span class="hl kwa">implicit none</span>

  <span class="hl kwb">integer</span><span class="hl sym">,</span> <span class="hl kwa">parameter</span> <span class="hl sym">::</span> LineLen <span class="hl sym">=</span> <span class="hl num">60</span><span class="hl sym">,</span> InitialTableSize <span class="hl sym">=</span> <span class="hl num">1</span>

  <span class="hl kwb">integer</span> <span class="hl sym">::</span> bufferSize <span class="hl sym">=</span> <span class="hl num">16384</span><span class="hl sym">,</span> stat<span class="hl sym">,</span> n <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">,</span> i
  <span class="hl kwb">logical</span> <span class="hl sym">::</span> atThirdPart <span class="hl sym">= .</span>false<span class="hl sym">.</span>
  <span class="hl kwa">type</span><span class="hl sym">(</span>table<span class="hl sym">) ::</span> kn
  <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=</span>LineLen<span class="hl sym">) ::</span> line
  <span class="hl kwb">character</span><span class="hl sym">,</span> <span class="hl kwa">dimension</span><span class="hl sym">(:),</span> allocatable <span class="hl sym">::</span> buffer<span class="hl sym">,</span> tempBuffer

  <span class="hl kwb">character</span><span class="hl sym">,</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">65</span><span class="hl sym">:</span><span class="hl num">116</span><span class="hl sym">),</span> <span class="hl kwa">parameter</span> <span class="hl sym">::</span> Codes <span class="hl sym">= (/</span> <span class="hl str">&quot;A&quot;</span><span class="hl sym">,</span> <span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> <span class="hl str">&quot;C&quot;</span><span class="hl sym">,  &amp;</span>
       <span class="hl sym">(</span><span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> i <span class="hl sym">=</span> <span class="hl num">68</span><span class="hl sym">,</span> <span class="hl num">70</span><span class="hl sym">),</span> <span class="hl str">&quot;G&quot;</span><span class="hl sym">, (</span><span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> i <span class="hl sym">=</span> <span class="hl num">72</span><span class="hl sym">,</span> <span class="hl num">83</span><span class="hl sym">),</span> <span class="hl str">&quot;T&quot;</span><span class="hl sym">, (</span><span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> i <span class="hl sym">=</span> <span class="hl num">85</span><span class="hl sym">,</span> <span class="hl num">96</span><span class="hl sym">),  &amp;</span>
       <span class="hl str">&quot;A&quot;</span><span class="hl sym">,</span> <span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> <span class="hl str">&quot;C&quot;</span><span class="hl sym">, (</span><span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> i <span class="hl sym">=</span> <span class="hl num">100</span><span class="hl sym">,</span> <span class="hl num">102</span><span class="hl sym">),</span> <span class="hl str">&quot;G&quot;</span><span class="hl sym">, (</span><span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> i <span class="hl sym">=</span> <span class="hl num">104</span><span class="hl sym">,</span> <span class="hl num">115</span><span class="hl sym">),</span> <span class="hl str">&quot;T&quot;</span> <span class="hl sym">/)</span>

  <span class="hl kwd">allocate</span><span class="hl sym">(</span><span class="hl kwd">buffer</span><span class="hl sym">(</span>bufferSize<span class="hl sym">))</span>

  <span class="hl slc">! Read FASTA file line-by-line, extracting sequence three, and converting to</span>
  <span class="hl slc">! uppercase.</span>
  <span class="hl kwa">do</span>
     <span class="hl kwa">read</span><span class="hl sym">(*,</span> <span class="hl str">&quot;(a)&quot;</span><span class="hl sym">,</span> iostat<span class="hl sym">=</span>stat<span class="hl sym">)</span> line
     <span class="hl kwa">if</span> <span class="hl sym">(</span>stat <span class="hl sym">/=</span> <span class="hl num">0</span><span class="hl sym">)</span> exit
     <span class="hl kwa">if</span> <span class="hl sym">(.</span>not<span class="hl sym">.</span> atThirdPart<span class="hl sym">)</span> <span class="hl kwa">then</span>
        atThirdPart <span class="hl sym">=</span> <span class="hl kwd">line</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">:</span><span class="hl num">3</span><span class="hl sym">) ==</span> <span class="hl str">&quot;&gt;TH&quot;</span>
     <span class="hl kwa">else</span>
        <span class="hl kwa">if</span> <span class="hl sym">(</span>n<span class="hl sym">+</span>LineLen <span class="hl sym">&gt;</span> bufferSize<span class="hl sym">)</span> <span class="hl kwa">then</span>
           <span class="hl kwd">allocate</span><span class="hl sym">(</span><span class="hl kwd">tempBuffer</span><span class="hl sym">(</span>bufferSize<span class="hl sym">))</span>
           tempBuffer <span class="hl sym">=</span> buffer
           <span class="hl kwd">deallocate</span><span class="hl sym">(</span>buffer<span class="hl sym">)</span>
           <span class="hl kwd">allocate</span><span class="hl sym">(</span><span class="hl kwd">buffer</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">*</span>bufferSize<span class="hl sym">))</span>
           <span class="hl kwd">buffer</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">:</span>bufferSize<span class="hl sym">) =</span> tempBuffer
           <span class="hl kwd">buffer</span><span class="hl sym">(</span>bufferSize<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">:</span><span class="hl num">2</span><span class="hl sym">*</span>bufferSize<span class="hl sym">) =</span> <span class="hl str">&quot; &quot;</span>
           <span class="hl kwd">deallocate</span><span class="hl sym">(</span>tempBuffer<span class="hl sym">)</span>
           bufferSize <span class="hl sym">=</span> <span class="hl num">2</span><span class="hl sym">*</span>bufferSize
        <span class="hl kwa">end if</span>
        <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> LineLen
           <span class="hl kwd">buffer</span><span class="hl sym">(</span>n<span class="hl sym">+</span>i<span class="hl sym">) =</span> <span class="hl kwd">Codes</span><span class="hl sym">(</span><span class="hl kwd">iachar</span><span class="hl sym">(</span><span class="hl kwd">line</span><span class="hl sym">(</span>i<span class="hl sym">:</span>i<span class="hl sym">)))</span>
        <span class="hl kwa">end do</span>
        n <span class="hl sym">=</span> n <span class="hl sym">+</span> LineLen
     <span class="hl kwa">end if</span>
  <span class="hl kwa">end do</span>

  n <span class="hl sym">=</span> <span class="hl kwd">minloc</span><span class="hl sym">(</span><span class="hl kwd">iachar</span><span class="hl sym">(</span>buffer<span class="hl sym">),</span><span class="hl num">1</span><span class="hl sym">) -</span> <span class="hl num">1</span>

  <span class="hl kwa">call</span> <span class="hl kwd">init_table</span><span class="hl sym">(</span>kn<span class="hl sym">,</span> InitialTableSize<span class="hl sym">)</span>

  <span class="hl kwa">call</span> <span class="hl kwd">write_frequencies</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">)</span>
  <span class="hl kwa">call</span> <span class="hl kwd">write_frequencies</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">)</span>

  <span class="hl kwa">call</span> <span class="hl kwd">write_count</span><span class="hl sym">(</span><span class="hl str">&quot;GGT&quot;</span><span class="hl sym">)</span>
  <span class="hl kwa">call</span> <span class="hl kwd">write_count</span><span class="hl sym">(</span><span class="hl str">&quot;GGTA&quot;</span><span class="hl sym">)</span>
  <span class="hl kwa">call</span> <span class="hl kwd">write_count</span><span class="hl sym">(</span><span class="hl str">&quot;GGTATT&quot;</span><span class="hl sym">)</span>
  <span class="hl kwa">call</span> <span class="hl kwd">write_count</span><span class="hl sym">(</span><span class="hl str">&quot;GGTATTTTAATT&quot;</span><span class="hl sym">)</span>
  <span class="hl kwa">call</span> <span class="hl kwd">write_count</span><span class="hl sym">(</span><span class="hl str">&quot;GGTATTTTAATTTATAGT&quot;</span><span class="hl sym">)</span>

<span class="hl kwa">contains</span>

  <span class="hl kwa">subroutine</span> <span class="hl kwd">write_frequencies</span><span class="hl sym">(</span>length<span class="hl sym">)</span>
    <span class="hl kwb">integer</span><span class="hl sym">,</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> length

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> numNuc<span class="hl sym">,</span> j
    <span class="hl kwa">type</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">4</span><span class="hl sym">**</span>length<span class="hl sym">) ::</span> nucleotides
    <span class="hl kwa">type</span><span class="hl sym">(</span><span class="hl kwa">key</span><span class="hl sym">) ::</span> temp

    numNuc <span class="hl sym">=</span> n <span class="hl sym">-</span> length <span class="hl sym">+</span> <span class="hl num">1</span>

    <span class="hl kwa">call</span> <span class="hl kwd">read_frame</span><span class="hl sym">(</span>buffer<span class="hl sym">,</span> numNuc<span class="hl sym">,</span> length<span class="hl sym">,</span> kn<span class="hl sym">)</span>

    nucleotides <span class="hl sym">=</span> <span class="hl kwd">keys_of_given_len</span><span class="hl sym">(</span>kn<span class="hl sym">,</span> length<span class="hl sym">)</span>

    <span class="hl slc">! Insertion sort</span>
    <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">2</span><span class="hl sym">,</span> <span class="hl kwd">size</span><span class="hl sym">(</span>nucleotides<span class="hl sym">)</span>
       temp <span class="hl sym">=</span> <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>i<span class="hl sym">)</span>
       <span class="hl kwa">do</span> j <span class="hl sym">=</span> i<span class="hl sym">,</span> <span class="hl num">2</span><span class="hl sym">, -</span><span class="hl num">1</span>
          <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">nucleotides</span><span class="hl sym">(</span>j<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">)%</span>count <span class="hl sym">&gt;</span> temp<span class="hl sym">%</span>count <span class="hl sym">.</span>or<span class="hl sym">.  &amp;</span>
               <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>j<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">)%</span>count <span class="hl sym">==</span> temp<span class="hl sym">%</span>count <span class="hl sym">.</span>and<span class="hl sym">.  &amp;</span>
               <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>j<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">)%</span>word <span class="hl sym">&lt;</span> temp<span class="hl sym">%</span>word<span class="hl sym">)</span> exit
          <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>j<span class="hl sym">) =</span> <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>j<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">)</span>
       <span class="hl kwa">end do</span>
       <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>j<span class="hl sym">) =</span> temp
    <span class="hl kwa">end do</span>

    <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> <span class="hl kwd">size</span><span class="hl sym">(</span>nucleotides<span class="hl sym">)</span>
       <span class="hl kwa">write</span><span class="hl sym">(*,</span> <span class="hl str">&quot;(a2,f6.3)&quot;</span><span class="hl sym">)</span> <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>i<span class="hl sym">)%</span><span class="hl kwd">word</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">:</span><span class="hl num">2</span><span class="hl sym">),  &amp;</span>
            <span class="hl num">100</span><span class="hl sym">. *</span> <span class="hl kwd">nucleotides</span><span class="hl sym">(</span>i<span class="hl sym">)%</span>count <span class="hl sym">/</span> <span class="hl kwb">real</span><span class="hl sym">(</span>numNuc<span class="hl sym">)</span>
    <span class="hl kwa">end do</span>
    <span class="hl kwa">write</span><span class="hl sym">(*,</span> <span class="hl str">&quot;(a)&quot;</span><span class="hl sym">)</span> <span class="hl str">&quot;&quot;</span>
  <span class="hl kwa">end subroutine</span> write_frequencies

  <span class="hl kwa">subroutine</span> <span class="hl kwd">write_count</span><span class="hl sym">(</span>string<span class="hl sym">)</span>
    <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=*),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> string

    <span class="hl kwb">character</span><span class="hl sym">,</span> <span class="hl kwa">parameter</span> <span class="hl sym">::</span> tab <span class="hl sym">=</span> <span class="hl kwd">achar</span><span class="hl sym">(</span><span class="hl num">9</span><span class="hl sym">)</span>
    <span class="hl kwb">integer</span> <span class="hl sym">::</span> length<span class="hl sym">,</span> numNuc

    length <span class="hl sym">=</span> <span class="hl kwd">len</span><span class="hl sym">(</span>string<span class="hl sym">)</span>
    numNuc <span class="hl sym">=</span> n <span class="hl sym">-</span> length <span class="hl sym">+</span> <span class="hl num">1</span>

    <span class="hl kwa">call</span> <span class="hl kwd">read_frame</span><span class="hl sym">(</span>buffer<span class="hl sym">,</span> numNuc<span class="hl sym">,</span> length<span class="hl sym">,</span> kn<span class="hl sym">)</span>

    <span class="hl kwa">write</span><span class="hl sym">(*,</span> <span class="hl str">&quot;(i0,a)&quot;</span><span class="hl sym">)</span> <span class="hl kwd">cnt</span><span class="hl sym">(</span>kn<span class="hl sym">,</span> string<span class="hl sym">),</span> tab<span class="hl sym">//</span>string
  <span class="hl kwa">end subroutine</span> write_count
<span class="hl kwa">end program</span> knucleotide
